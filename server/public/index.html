<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>High Efficiency Live Link Observer</title>
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header-container">
    <div class="header-top">
      <div class="header-title">
        <picture>
          <img class="logotype-software" src="assets/logotype.svg" width="350" height="150" alt="Logotypr">
        </picture>
      </div>
    </div>
    
    <div class="header-bottom">
      <div class="nav">
        <a href="?room=paris" class="nav-link">Paris</a>
        <a href="?room=moscow" class="nav-link">Moscow</a>
        <a href="?room=london" class="nav-link">London</a>
      </div>
    
    </div>
  </div>

  <main>
    <div class="grid" id="grid">
      <div class="empty-state" id="emptyState">
        <div class="empty-text">Ожидание подключения студентов</div>
        <div class="empty-subtext">Как только студенты подключатся, их экраны появятся здесь</div>
      </div>
    </div>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const ROOM = new URLSearchParams(location.search).get('room') || 'paris';
    const ID = "teacher"
   

    document.querySelectorAll('.nav-link').forEach(link => {
      if (link.getAttribute('href').includes(ROOM)) {
        link.classList.add('active');
      }
    });

    const socket = io('/', { query: { role: 'teacher', room: ROOM, id: ID }});
    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('emptyState');
    const students = {}; 

    function ensureStudent(id) {
      if (students[id]) return students[id];
     
      if (emptyState.style.display !== 'none') {
        emptyState.style.display = 'none';
      }

      const card = document.createElement('div');
      card.className = 'card';
      
      const cardHeader = document.createElement('div');
      cardHeader.className = 'card-header';
      
      const avatar = document.createElement('div');
      avatar.className = 'student-avatar';
      avatar.innerText = id.slice(0,2).toUpperCase();
      
      const studentInfo = document.createElement('div');
      studentInfo.className = 'student-info';
      
      const studentId = document.createElement('div');
      studentId.className = 'student-id';
      studentId.innerText = id;
      
      const studentStatus = document.createElement('div');
      studentStatus.className = 'student-status';
      studentStatus.innerHTML = '<div class="status-dot"></div> Активен';
      
      studentInfo.appendChild(studentId);
      studentInfo.appendChild(studentStatus);
      cardHeader.appendChild(avatar);
      cardHeader.appendChild(studentInfo);
      
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      const canvas = document.createElement('canvas');
      canvas.width = 1280;
      canvas.height = 720;
      const ctx = canvas.getContext('2d');
      
      cardContent.appendChild(canvas);
      card.appendChild(cardHeader);
      card.appendChild(cardContent);
      grid.prepend(card);
      
      students[id] = { canvas, ctx, img: new Image(), card };
      students[id].img.onload = () => {
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(students[id].img, 0, 0, w, h);
      };
      return students[id];
    }

    socket.on('student-frame-binary', ({ id, frame }) => {
      const arr = new Uint8Array(frame);
      const blob = new Blob([arr], { type: 'image/jpeg' });
      const objURL = URL.createObjectURL(blob);
      const s = ensureStudent(id);
      s.img.src = objURL;
      setTimeout(()=>URL.revokeObjectURL(objURL), 2000);
    });

    socket.on('student-disconnected', ({ id }) => {
      if (students[id]) {
        students[id].card.remove();
        delete students[id];
        if (Object.keys(students).length === 0) {
          emptyState.style.display = 'block';
        }
      }
    });

    socket.on('connect', () => {
      document.getElementById('connectionStatus').textContent = 'Connected';
    });

  </script>
</body>
</html>