<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teacher Live View</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:8px; background:#111; color:#fff; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:8px; }
    .card { background:#222; border-radius:6px; padding:6px; }
    canvas { width:100%; height:180px; background:#000; display:block; border-radius:4px; }
    .meta { font-size:12px; color:#ddd; margin-bottom:6px; }
  </style>
</head>
<body>
  <h2>Аудитория: <span id="room"></span></h2>
  <div class="grid" id="grid"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const ROOM = new URLSearchParams(location.search).get('room') || 'auditorium-101';
    const ID = 'teacher-' + Math.random().toString(36).slice(2,8);
    document.getElementById('room').innerText = ROOM;

    const socket = io('/', { query: { role: 'teacher', room: ROOM, id: ID }});
    const grid = document.getElementById('grid');
    const students = {}; 

    function ensureStudent(id) {
      if (students[id]) return students[id];
      const card = document.createElement('div'); card.className = 'card';
      const meta = document.createElement('div'); meta.className = 'meta'; meta.innerText = id;
      const canvas = document.createElement('canvas'); canvas.width = 1280; canvas.height = 720;
      const ctx = canvas.getContext('2d');
      card.appendChild(meta); card.appendChild(canvas);
      grid.prepend(card);
      students[id] = { canvas, ctx, img: new Image() };
      students[id].img.onload = () => {
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(students[id].img, 0, 0, w, h);
      };
      return students[id];
    }

    socket.on('student-frame-binary', ({ id, frame }) => {
      const arr = new Uint8Array(frame);
      const blob = new Blob([arr], { type: 'image/jpeg' });
      const objURL = URL.createObjectURL(blob);
      const s = ensureStudent(id);
      s.img.src = objURL;
      setTimeout(()=>URL.revokeObjectURL(objURL), 2000);
    });

    socket.on('student-disconnected', ({ id }) => {
      if (students[id]) {
        students[id].canvas.parentElement.remove();
        delete students[id];
      }
    });

    socket.on('connect', ()=>console.log('connected as teacher'));
  </script>
</body>
</html>
